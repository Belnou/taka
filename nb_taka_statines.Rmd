---
title: "R Notebook"
output: html_notebook
---

                                                STATINES

Base de donnees pour les analyses sur les statines
```{r}
bd_statine <- mabase
```


CREATION VARIABLE DE SURVIE POUR EVALUER L'IMPACT des STATINES SUR LA SURVENUE DE RECHUTES
```{r rows.print=128}
bd_statine_1 <- bd_statine %>% mutate(periode=factor("1"))
bd_statine_2 <- bd_statine_1[which(bd_statine_1$presence_statine==1),]  
bd_statine_2 <- bd_statine_2  %>% mutate(periode = factor("2"))  
bd_statine <- base::rbind(bd_statine_1, bd_statine_2)   

bd_statine <- bd_statine %>%
  mutate(date_start = case_when(
    periode == "1" ~ date_j0_ttt,
    periode == "2" ~ date_premiere_statine
  )) %>% 
   mutate(date_end = case_when(
    periode == "2" & rechute_1==1  ~ date_rechute_1,
    periode == "2" & rechute_1==0  ~ date_fin_ligne_therapeutique_ttt,
    periode == "1" & presence_statine==1  ~ date_premiere_statine,
    periode == "1" & presence_statine==0 & rechute_1==1  ~ date_rechute_1,
    periode == "1" & presence_statine==0 & rechute_1==0  ~ date_fin_ligne_therapeutique_ttt
  )) %>% 
  mutate(time1 = as.integer(case_when(
     presence_statine ==1 & periode == "2" ~ date_premiere_statine - date_j0_ttt))) %>% 
  mutate(time1 = case_when(
      presence_statine ==1 & periode == "2"~ time1,
      TRUE ~ 0L
      )) %>% 
  mutate(time2 = as.integer(case_when(
      presence_statine ==1 & periode == "1" ~ date_premiere_statine - date_j0_ttt,
      presence_statine ==1 & periode == "2" ~ date_end - date_premiere_statine,
      presence_statine ==0 ~ date_end - date_j0_ttt))) %>% 
    mutate(time3 = case_when(
    time1 == 0 ~ time2,
    time1 != 0 ~ time1 + time2)) %>% 
    mutate(event = case_when(
         presence_statine ==1 & periode == "1" ~ 0L,
         presence_statine ==1 & periode == "2" ~ as.integer(as.character(rechute_1)),
         presence_statine ==0 ~ as.integer(as.character(rechute_1))
         )) %>% 
  mutate(time1=round(time1/30.45, digits=1),
         time2=round(time2/30.45, digits=1),
         time3=round(time3/30.45, digits=1)
  ) %>% 
    mutate(statut_statine = case_when(
    presence_statine ==1 & periode == "1"~ 0L,
    presence_statine ==1 & periode == "2"~ 1L,
    presence_statine ==0 ~ 0L
  )) %>% 
    mutate(
    time4 = 0,
    time5 = time2
  )
```




```{r}
 
map_dbl(map(bd_statine,is.na), sum)

library(survival)
model <- coxph(Surv(time5, event) ~ statut_statine , data = bd_statine)
model %>%
  tidy() %>%
  mutate(
    HR = exp(estimate),
    lower_95 = exp(conf.low),
    upper_95 = exp(conf.high )
  ) %>% 
  select (term, estimate, HR, lower_95, upper_95, p.value) %>%
  mutate_at(vars(estimate, HR, lower_95, upper_95,p.value ), function(x) round(x, 4))

fit0 <- survfit(Surv(time5, event) ~ statut_statine , data = bd_statine)
ggsurvplot(fit0, 
           surv.median.line = "hv",
           xlab="Time (months)",
           #fun="event",
           break.x.by = 60,
           xlim = c(0, 192),
           conf.int = TRUE,
           conf.int.alpha = 0.1,
           #risk.table = TRUE,
           #cumevents = TRUE,
           #cumcensor = TRUE,
           censor = FALSE,
           tables.height = 0.175,
           tables.theme = theme_cleantable(),
           palette = c("#993333", "#0066CC"),
           ggtheme = theme_bw())

# Si besoin essai en excluant les patients qui ont debute d'emble avec des statine, mais le modele les exclus automatiquement 
bd_statine_essai <- bd_statine %>% filter(!(presence_statine==1 & time2==0))
```



Pour nos objectifs:
on voudrait d'abord analyser l'effet des statines
Est ce que le fait de prendre un traitement par statine 
- diminue les complications immunologiques, c'est Ã  dire diminue les rechutes et/ou la dose de corticoides et/ou le recours aux immunosuppresseurs?
- diminue les complications vasculaires et/ou les gestes vasculaires ?