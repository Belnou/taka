---
title: "R Notebook"
output: html_notebook
---

                                                STATINES


CREATION VARIABLE DE SURVIE POUR STATINE
```{r}
bd_statine_1 <- bd_statine %>% mutate(periode=factor("1"))
bd_statine_2 <- bd_statine_1[which(bd_statine_1$presence_statine==1),]  
bd_statine_2 <- bd_statine_2  %>% mutate(periode = factor("2"))  
bd_stat <- base::rbind(bd_statine_1, bd_statine_2)   

  
bd_stat <- bd_stat %>%
  mutate(date_start = case_when(
    periode == "1" ~ date_j0_ttt,
    periode == "2" ~ date_premiere_statine
  )) %>% 
   mutate(date_end = case_when(
    periode == "2" & rechute_1==1  ~ date_rechute_1,
    periode == "2" & rechute_1==0 & !is.na(date_fin_ligne_therapeutique_ttt) ~ date_fin_ligne_therapeutique_ttt,
    periode == "2" & rechute_1==0 & is.na(date_fin_ligne_therapeutique_ttt)  ~ date_derniere_nouvelle_ttt,
    periode == "1" & presence_statine==1  ~ date_premiere_statine,
    periode == "1" & presence_statine==0 & rechute_1==1  ~ date_rechute_1,
    periode == "1" & presence_statine==0 & rechute_1==0 & !is.na(date_fin_ligne_therapeutique_ttt) ~ date_fin_ligne_therapeutique_ttt,
    periode == "1" & presence_statine==0 & rechute_1==0 & is.na(date_fin_ligne_therapeutique_ttt) ~ date_derniere_nouvelle_ttt)
    ) %>% 
      mutate(time1 = as.integer(case_when(
      presence_statine ==1 & periode == "2" ~ date_premiere_statine - date_j0_ttt))) %>% 
    mutate(time1 = case_when(
      presence_statine ==1 & periode == "2"~ time1,
      TRUE ~0L
      )
    ) %>% 
    mutate(time2 = as.integer(case_when(
      presence_statine ==1 & periode == "1" ~ date_premiere_statine - date_j0_ttt,
      presence_statine ==1 & periode == "2" ~ date_end - date_premiere_statine,
      presence_statine ==0 ~ date_end - date_j0_ttt))) %>% 
    mutate(time3 = case_when(
    time1 == 0 ~ time2,
    time1 != 0 ~ time1 + time2)) %>% 
    mutate(event = case_when(
         presence_statine ==1 & periode == "1" ~ 0L,
         presence_statine ==1 & periode == "2" ~ as.integer(as.character(rechute_1)),
         presence_statine ==0 ~ as.integer(as.character(rechute_1))
         )) %>% 
    mutate(time1=round(time1/30.45, digits=1),
         time2=round(time2/30.45, digits=1),
         time3=round(time3/30.45, digits=1)) %>% 
    mutate(statut_statine = case_when(
    presence_statine ==1 & periode == "1"~ 0L,
    presence_statine ==1 & periode == "2"~ 1L,
    presence_statine ==0 ~ 0L
  )) %>% 
    mutate(
    time4 = 0,
    time5 = time2
  )
    

  
# Pour le moment exclure comme ça les patients 16 et 52
bd_stat <- bd_stat %>% filter(n != 16 & n!=52)  
map_dbl(map(bd_stat,is.na), sum)



library(survival)
bd_stat  <- bd_stat  %>% mutate (statut_statine = as.factor(statut_statine))
mod <- coxph(Surv(time4, time5, event)~ statut_statine , data = bd_stat)
mod %>%
  tidy() %>%
  mutate(
    HR = exp(estimate),
    lower_95 = exp(conf.low),
    upper_95 = exp(conf.high )
  ) %>% 
  select (term, estimate, HR, lower_95, upper_95, p.value) %>%
  mutate_at(vars(estimate, HR, lower_95, upper_95,p.value ), function(x) round(x, 4))


fit <- survfit(Surv(time5, event) ~ statut_statine, data = bd_stat)

ggsurvplot(fit, 
           surv.median.line = "hv",
           xlab="Time (months)",
           #fun="event",
           break.x.by = 60,
           xlim = c(0, 360),
           conf.int = TRUE,
           conf.int.alpha = 0.1,
           #risk.table = TRUE,
           #cumevents = TRUE,
           #cumcensor = TRUE,
           censor = FALSE,
           tables.height = 0.175,
           tables.theme = theme_cleantable(),
           palette = c("#993333", "#0066CC"),
           ggtheme = theme_bw())

bd_stat %>% select(n, date_j0_ttt, presence_statine, date_premiere_statine,date_derniere_nouvelle_ttt, date_fin_ligne_therapeutique_ttt,rechute_1,date_rechute_1, time2)

# Export pour voir les problemes
bd_stat_sortie<- bd_stat  %>% select(n,num_ligne_ttt, date_j0_ttt, presence_statine,periode, statut_statine,rechute_1,date_rechute_1,event,rechute_2, date_rechute_2, date_premiere_statine,date_derniere_nouvelle_ttt, date_fin_ligne_therapeutique_ttt,rechute_1, time1, time2, time3, time4, time5) %>% arrange(n, num_ligne_ttt)

write.table(bd_stat_sortie,"bd_stat_sortie.csv", row.names = FALSE, sep ="*", dec=",", na=" ")


# Combien de dates de rechute apres la fin de ligne thérapeutique
bd_stat %>% select(n, num_ligne_ttt, rechute_1, date_rechute_1, date_fin_ligne_therapeutique_ttt) %>% 
  filter((as.integer(date_fin_ligne_therapeutique_ttt-date_rechute_1))<0) %>% 
  mutate(delai_rechute = date_rechute_1-date_fin_ligne_therapeutique_ttt)
```



Pour nos objectifs:
on voudrait d'abord analyser l'effet des statines
Est ce que le fait de prendre un traitement par statine 
- diminue les complications immunologiques, c'est à dire diminue les rechutes et/ou la dose de corticoides et/ou le recours aux immunosuppresseurs?
- diminue les complications vasculaires et/ou les gestes vasculaires ?